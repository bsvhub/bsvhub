<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>BSVhub.io â€” Bitcoin SV Tools, Apps, Wallets & Resources</title>

    <meta name="description"
          content="BSVhub.io â€” one place for all your Bitcoin SV related content including tools, apps, wallets, marketplaces, documentation, and community links.">

    <meta name="keywords"
          content="Bitcoin SV, BSV, Bitcoin SV tools, BSV apps, BSV wallets, BSV marketplace, Bitcoin SV resources">

    <meta name="robots" content="index, follow">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph (social previews) -->
    <meta property="og:title" content="BSVhub.io â€” Bitcoin SV Hub">
    <meta property="og:description" content="One place for all your Bitcoin SV related content.">
    <meta property="og:url" content="https://bsvhub.io/">
    <meta property="og:type" content="website">

    <!-- MAIN STYLES -->
    <link rel="stylesheet" href="styles/unified.css">
    <link rel="stylesheet" href="styles/firefly.css">
    
    <!-- EARLY MOBILE DETECTION - Prevents flash of desktop content -->
    <script>
    (function() {
        const savedMode = localStorage.getItem("ui-mode");
        const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                              || (window.innerWidth <= 768);
        
        // Apply mobile-mode class immediately if needed
        if (savedMode === "mobile" || (!savedMode && isMobileDevice)) {
            document.documentElement.classList.add('mobile-mode-loading');
        }
    })();
    </script>
</head>

<body>
<div id="page-wrapper">
<!-- ============================================================
     LAYER 0 â€” BACKGROUND LAYERS
============================================================ -->

<div id="background-layer" class="background-layer"></div>
<div id="firefly-layer" class="firefly-layer"></div>

<audio id="copy-sfx" src="styles/assets/copy.mp3"></audio>


<!-- ============================================================
     LAYER 1 â€” TOP UI (HEADER + TAB BAR + TOOLTIP)
============================================================ -->

<div id="top-ui">

    <!-- HEADER -->
    <header class="header-container">
        <div class="header-icons header-icons-left">
            <a href="#" data-target="about-section" class="header-icon-link header-text-link">
                <img src="icon/about.svg" alt="About" class="header-icon">
            </a>
            <a href="#" data-target="tip-section" class="header-icon-link header-text-link">
                <img src="icon/tip.svg" alt="Tip" class="header-icon">
            </a>
        </div>

        <h1 class="header-title">â‚¿SVhub.io</h1>

        <div class="header-icons header-icons-right">
            <a href="#" data-target="contact-section" class="header-icon-link header-text-link">
                <img src="icon/contact.svg" alt="Contact" class="header-icon">
            </a>
            <a href="#" id="mobile-toggle" class="header-icon-link header-text-link">
                <img src="icon/mobile.svg" alt="Mobile" class="header-icon mobile-mode-icon">
                <img src="icon/desktop.svg" alt="Desktop" class="header-icon desktop-mode-icon">
            </a>
        </div>
    </header>


    <!-- TAB BAR -->
    <nav class="tab-bar">

        <button class="tab-btn" data-target="tool"><span>Tools</span></button>
        <button class="tab-btn" data-target="app"><span>Apps</span></button>
        <button class="tab-btn" data-target="wallet"><span>Wallets</span></button>
        <button class="tab-btn" data-target="exchange"><span>Get BSV</span></button>
        <button class="tab-btn" data-target="market"><span>Market</span></button>
        <button class="tab-btn" data-target="bsv"><span>Info</span></button>
        <button class="tab-btn" data-target="doc"><span>Tech Docs</span></button>
        <button class="tab-btn" data-target="social"><span>SM</span></button>
        <button class="tab-btn" data-target="video"><span>Videos</span></button>
       
        <div class="search-container">
            <input id="search-box" type="text" placeholder="search here">
        </div>

    </nav>

    <!-- TOOLTIP BAR -->
    <div id="tooltip-display"></div>

</div>



<!-- ============================================================
     LAYER 2 â€” CONTENT AREA (SCROLLABLE)
============================================================ -->

<main id="content-area">
    <div id="content-scale">
        <!-- SEARCH RESULTS -->
        <section id="search-results" class="tab-content"></section>
    </div>
</main>
 
    
<!-- ============================================================
     JS SECTION 1 â€” TOOLTIPS + MOBILE DOUBLE-TAP (EVENT DELEGATION)
     ------------------------------------------------------------
     Desktop: Hover tooltips, single-click links
     Mobile: First tap = tooltip, second tap = navigate
     Uses event delegation - works on all icons automatically
============================================================ -->
<script>
/* ============================================================
   TOOLTIP STATE
============================================================ */
const tooltipBox = document.getElementById("tooltip-display");
let defaultTooltipMessage = "Loading...";
let revertTimeout = null;
let lastTappedLink = null;

/* ============================================================
   UPDATED: isMobileMode() function
   ============================================================
   This function now checks for body.mobile-mode class instead
   of checking if mobile.css is loaded.
   
   REPLACE the existing isMobileMode() function in index.html
   (around line 112-115) with this:
============================================================ */
function isMobileMode() {
    return document.body.classList.contains("mobile-mode");
}

/* ============================================================
   DEFAULT TOOLTIP (MARQUEE) - DYNAMIC SPEED BASED ON LENGTH
============================================================ */
fetch("tooltip-message.txt")
    .then(r => r.text())
    .then(t => {
        defaultTooltipMessage = t.trim();
        showDefaultTooltip();
    })
    .catch(showDefaultTooltip);

function showDefaultTooltip() {
    const separator = "\u00A0\u00A0\u00A0â€¢\u00A0\u00A0\u00A0";
    const repeated = Array(5).fill(defaultTooltipMessage).join(separator);
    tooltipBox.innerHTML = `<span>${repeated}</span>`;
    tooltipBox.classList.add("marquee");
    tooltipBox.classList.remove("expanded");
    
    // Calculate animation duration based on text length
    const span = tooltipBox.querySelector('span');
    if (span) {
        const textLength = defaultTooltipMessage.length;
        
        // Base speed: ~60 pixels per second (adjust multiplier to taste)
        // Longer text = proportionally longer duration for consistent speed
        const duration = Math.max(10, textLength * 0.15); // min 10s, scales with length
        
        span.style.animationDuration = `${duration}s`;
    }
}

/* ============================================================
   SET TOOLTIP TEXT
============================================================ */
function setTooltipText(text) {
    if (revertTimeout) clearTimeout(revertTimeout);

    if (text) {
        tooltipBox.innerHTML = text;
        tooltipBox.classList.remove("marquee");
        tooltipBox.classList.add("expanded");
    } else {
        revertTimeout = setTimeout(showDefaultTooltip, 2000);
    }

    // Re-measure layout after tooltip change
    requestAnimationFrame(() => {
        if (typeof positionContent === "function") positionContent();
    });
}

/* ============================================================
   DESKTOP HOVER TOOLTIPS (EVENT DELEGATION)
============================================================ */
document.addEventListener("mouseenter", (e) => {
    if (isMobileMode()) return;
    const wrap = e.target.closest(".icon-wrapper[data-tooltip]");
    if (wrap) setTooltipText(wrap.dataset.tooltip);
}, true);

document.addEventListener("mouseleave", (e) => {
    if (isMobileMode()) return;
    const wrap = e.target.closest(".icon-wrapper[data-tooltip]");
    if (wrap) setTooltipText("");
}, true);

/* ============================================================
   MOBILE DOUBLE-TAP (EVENT DELEGATION)
============================================================ */
document.addEventListener("click", (e) => {
    if (!isMobileMode()) return;
    
    const wrap = e.target.closest(".icon-wrapper");
    if (!wrap) return;
    
    const link = wrap.closest("a");
    if (!link) return;

    // Clear previous selection if different icon
    if (lastTappedLink && lastTappedLink !== link) {
        lastTappedLink.classList.remove("mobile-selected");
    }

    // First tap - show tooltip
    if (!link.classList.contains("mobile-selected")) {
        e.preventDefault();
        link.classList.add("mobile-selected");
        lastTappedLink = link;
        setTooltipText(wrap.dataset.tooltip || wrap.textContent || "Tap again to open");
        return;
    }

    // Second tap - navigate (allow default)
    link.classList.remove("mobile-selected");
    lastTappedLink = null;
}, true);

/* ============================================================
   CLEAR SELECTION HELPER
============================================================ */
function clearDoubleTapSelection() {
    if (lastTappedLink) {
        lastTappedLink.classList.remove("mobile-selected");
        lastTappedLink = null;
        setTooltipText("");
    }
}

/* ============================================================
   AUTO-CLEAR TRIGGERS
============================================================ */
document.addEventListener('pointerdown', (e) => {
    if (!isMobileMode()) return;
    const isIconArea = e.target.closest('.icon-wrapper');
    if (!isIconArea) clearDoubleTapSelection();
}, { capture: true });

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') clearDoubleTapSelection();
});

window.addEventListener('blur', clearDoubleTapSelection);

document.addEventListener('visibilitychange', () => {
    if (document.hidden) clearDoubleTapSelection();
});

/* ============================================================
   TOOLTIP HEIGHT TRANSITION HANDLER
============================================================ */
tooltipBox.addEventListener("transitionend", (e) => {
    if (e.propertyName === "max-height" || e.propertyName === "padding") {
        if (typeof positionContent === "function") positionContent();
    }
});
</script>  
    
<!-- ============================================================
     JS SECTION 2 â€” BACKGROUND GRADIENT
============================================================ -->

<script>
const colors = ["#555555", "#6a0dad", "#001f54"];
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
document.getElementById("background-layer").style.background =
  `linear-gradient(135deg, ${shuffle([...colors]).join(', ')})`;
</script>


<!--=========================================================
     JS SECTION 3 â€” TAB SYSTEM  (WITH SEARCH RESET ADDED)
============================================================ -->
<script>
const tabButtons = document.querySelectorAll('.tab-btn');
const headerLinks = document.querySelectorAll('.header-text-link:not(#mobile-toggle)');


/* ------------------------------------------------------------
   RESET SEARCH
   - clears input
   - hides search results section
   - resets layout
------------------------------------------------------------ */
function resetSearch() {
    const resultSec = document.getElementById("search-results");
    const searchBox = document.getElementById("search-box");

    searchBox.value = "";                 // clear input
    resultSec.innerHTML = "";             // clear search results
    resultSec.classList.remove("active"); // hide search results

    // DEACTIVATE ALL TAB CONTENTS
    document.querySelectorAll('.tab-content').forEach(sec =>
        sec.classList.remove('active')
    );

    requestAnimationFrame(() => {
        if (typeof positionContent === "function") {
            positionContent(null);        // fix layout
        }
    });
}


/* ------------------------------------------------------------
   ACTIVATE TAB
------------------------------------------------------------ */
function activateTab(targetId, source) {
    tabButtons.forEach(b => b.classList.remove('active'));
    headerLinks.forEach(h => h.classList.remove('active'));

    if (source) source.classList.add('active');

    document.querySelectorAll('.tab-content').forEach(sec =>
        sec.classList.remove('active')
    );

    const sec = document.getElementById(targetId);
    if (sec) sec.classList.add('active');
    
    // Desktop: scroll window
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Mobile: scroll content-area directly (handles scaled content)
    const contentArea = document.getElementById('content-area');
    if (contentArea) {
        contentArea.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

/* ------------------------------------------------------------
   TAB BUTTON CLICK â€” WITH SEARCH RESET
------------------------------------------------------------ */
tabButtons.forEach(btn =>
    btn.addEventListener("click", () => {
        clearDoubleTapSelection(); // <-- NEW: release any armed icon
        resetSearch();  // <-- NEW
        activateTab(btn.dataset.target, btn);
    })
);


/* ------------------------------------------------------------
   AUTO-ACTIVATE APPS TAB ON PAGE LOAD
------------------------------------------------------------ */
// ðŸ”§ REMOVED: Now handled in JSON loader (section 5) to avoid race condition

/* ------------------------------------------------------------
   HEADER LINK CLICK â€” WITH SEARCH RESET
------------------------------------------------------------ */
headerLinks.forEach(link =>
    link.addEventListener("click", (e) => {
        e.preventDefault();
        clearDoubleTapSelection(); // <-- NEW: release any armed icon
        resetSearch();  // <-- NEW
        activateTab(link.dataset.target, link);
    })
);

</script>



<script>
/* ============================================================
   4 â€” BASELINE CONTENT POSITIONING (NO HOVER SHIFTING)
   Keeps content-area placed directly below #top-ui.
   ============================================================ */


// index.html â€” reuse your existing positionContent function to also set a CSS var
(function () {
  const content = document.getElementById("content-area");
  const topUI = document.getElementById("top-ui");

  /* Fix extra blank space below icon-grid when --mobile-scale < 1.
     CSS transforms don't affect layout, so the scroll container sees the
     full pre-transform height. Compensate with a negative margin-bottom
     equal to: naturalHeight Ã— (scale - 1), which is negative when scale < 1. */
  function fixScaleSpacing() {
    const isMobile = document.body.classList.contains("mobile-mode")
                  || document.documentElement.classList.contains("mobile-mode-loading");
    const cs = document.getElementById("content-scale");
    if (!cs) return;
    if (isMobile) {
      const scale = parseFloat(
        getComputedStyle(document.documentElement).getPropertyValue("--mobile-scale")
      ) || 1;
      cs.style.marginBottom = cs.scrollHeight * (scale - 1) + "px";
    } else {
      cs.style.marginBottom = "";
    }
  }
  window.fixScaleSpacing = fixScaleSpacing;

  function positionContent() {
    const baseTop = topUI.offsetHeight;

    // Only apply inline top positioning in desktop mode
    // Mobile mode uses CSS fixed positioning (top: 0)
    const isMobileMode = document.body.classList.contains("mobile-mode")
                       || document.documentElement.classList.contains("mobile-mode-loading");

    if (!isMobileMode) {
      content.style.top = `${baseTop}px`;
    } else {
      content.style.top = '';  // Clear inline style in mobile mode
    }

    document.documentElement.style.setProperty('--top-ui-height', `${baseTop}px`);
    fixScaleSpacing();
  }
  window.positionContent = positionContent;
  window.addEventListener("resize", positionContent);
  requestAnimationFrame(positionContent);
})();

</script>

<!-- ============================================================
     JS SECTION 5 â€” JSON LOADER (NEW STRUCTURE)
     - builds header sections
     - filters items by tab
     - sorts alphabetically by "text"
     - creates 4-position badge system
     - applies zoom per icon
============================================================ -->
<script>
Promise.all([fetch("about.json").then(r => r.json()), fetch("list.json").then(r => r.json())])
  .then(([about, data]) => {
    const container = document.getElementById("content-scale");

    // ========================================
    // 1. BUILD HEADER SECTIONS (About, Tip, Contact)
    // ========================================

    Object.entries(about).forEach(([id, section]) => {
      const sec = document.createElement("section");
      sec.id = id + "-section";
      sec.className = "tab-content header-tab-content";
      if (section.html) sec.innerHTML = section.html;
      container.appendChild(sec);
    });

    // ========================================
    // 2. GET ALL UNIQUE TAB NAMES FROM ITEMS
    // ========================================
    const tabNames = new Set();
    data.items.forEach(item => {
      const tabs = item.tab.split(";");
      tabs.forEach(t => tabNames.add(t.trim()));
    });

    // ========================================
    // 3. BUILD EACH TAB SECTION
    // ========================================
    tabNames.forEach(tabName => {
      const sec = document.createElement("section");
      sec.id = tabName;
      sec.className = "tab-content";

      const ul = document.createElement("ul");
      ul.className = "icon-grid";

      // FILTER items that belong to this tab
      const tabItems = data.items.filter(item => {
        const tabs = item.tab.split(";").map(t => t.trim());
        return tabs.includes(tabName);
      });

      // SORT alphabetically by "text" field
      tabItems.sort((a, b) => {
        const textA = (a.text || "").toLowerCase();
        const textB = (b.text || "").toLowerCase();
        return textA.localeCompare(textB);
      });

      // BUILD each icon
      tabItems.forEach(item => {
        const li = document.createElement("li");

        const a = document.createElement("a");
        a.href = item.href || "#";
        a.target = "_blank";

        const wrap = document.createElement("div");
        wrap.className = "icon-wrapper";
        if (item.tooltip) wrap.dataset.tooltip = item.tooltip;

        // SET ZOOM (as CSS variable)
        if (item.zoom) {
          wrap.style.setProperty("--icon-zoom", item.zoom);
        }

        // Base icon image
        const img = document.createElement("img");
        img.src = item.img || "";
        img.alt = item.alt || "";
        wrap.appendChild(img);

        // ========================================
        // 4-POSITION BADGE SYSTEM
        // ========================================
        if (item.info) {
          const badges = item.info.split(";"); // e.g., "new.png;;verified.png;"
          
          badges.forEach((badgeFile, index) => {
            if (badgeFile.trim()) {  // only if not empty
              const badge = document.createElement("img");
              badge.src = "icon/" + badgeFile.trim();
              badge.alt = "";
              badge.className = `icon-badge-pos${index + 1}`; // pos1, pos2, pos3, pos4
              wrap.appendChild(badge);
            }
          });
        }

        // Icon label under the image
        const txt = document.createElement("div");
        txt.className = "icon-text";
        txt.textContent = item.text || "";
        wrap.appendChild(txt);

        // Assemble
        a.appendChild(wrap);
        li.appendChild(a);
        ul.appendChild(li);
      });

      sec.appendChild(ul);
      container.appendChild(sec);
    });

    
    // ========================================
    // 5. ACTIVATE DEFAULT TAB
    // ========================================
    // ðŸ”§ CHANGE: Activate "Apps" tab instead of first tab (Tools)
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const appsBtn = document.querySelector('.tab-btn[data-target="app"]');
        if (appsBtn) {
          activateTab(appsBtn.dataset.target, appsBtn);
        }
        if (typeof positionContent === "function") positionContent();
      });
    });

  })
  .catch(err => console.error(err));
</script>

<!-- ============================================================
     VISITOR COUNTER SCRIPT
============================================================ -->
<script>
(function() {
    function loadCounter() {
        const counterSpan = document.getElementById('visit-counter');
        if (counterSpan) {
            const iframe = document.createElement('iframe');
            iframe.style.border = 'none';
            iframe.style.width = '100%';
            iframe.style.height = '30px';
            iframe.style.verticalAlign = 'middle';
            iframe.style.display = 'block';
            iframe.style.marginTop = '10px';  // Add space above counter
            counterSpan.appendChild(iframe);
            
            const iframeDoc = iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write('<html><body style="margin:0;padding:0;font-family:VT323,monospace;font-size:2rem;color:#ffd700;text-align:center;"><script src="https://counter.websiteout.com/js/7/6/0/0"><\/script></body></html>');
            iframeDoc.close();
        } else {
            setTimeout(loadCounter, 100);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadCounter);
    } else {
        loadCounter();
    }
})();
</script>
    
<!-- ============================================================
     JS SECTION 6 â€” SEARCH SYSTEM (NEW STRUCTURE - ENHANCED)
     - Searches: tab, href, tooltip, alt, text, info
     - Alphabetically sorted results
     - No duplicates
============================================================ -->
<script>
const searchBox = document.getElementById("search-box");
const resultSec = document.getElementById("search-results");
const excludedTabs = ["about-section", "tip-section", "contact-section"];

searchBox.addEventListener("input", () => {
    clearDoubleTapSelection();
    const q = searchBox.value.toLowerCase();

    // Clear previous search results
    resultSec.innerHTML = "";

    // If search is empty, hide results
    if (!q) {
        resultSec.classList.remove("active");
        requestAnimationFrame(() => { if (typeof fixScaleSpacing === 'function') fixScaleSpacing(); });
        return;
    }

    // DEACTIVATE CURRENT TAB AND TAB BUTTONS
    document.querySelectorAll('.tab-content').forEach(sec =>
        sec.classList.remove('active')
    );
    document.querySelectorAll('.tab-btn').forEach(btn =>
        btn.classList.remove('active')
    );

    const grid = document.createElement("ul");
    grid.className = "icon-grid";
    const foundItems = []; // Store items with their text for sorting

    // Search through all tab sections
    document.querySelectorAll('.tab-content').forEach(sec => {
        if (excludedTabs.includes(sec.id)) return;  // Skip header sections

        sec.querySelectorAll('.icon-wrapper').forEach(icon => {

            // ========================================
            // SEARCHABLE FIELDS
            // ========================================
            
            // 1. TEXT - visible label under icon
            const txt = icon.querySelector('.icon-text')?.textContent.toLowerCase() || "";

            // 2. TOOLTIP - data-tooltip attribute
            const tooltip = (icon.dataset.tooltip || "").toLowerCase();

            // 3. HREF - link URL
            const link = icon.closest('a');
            const href = link ? (link.getAttribute('href') || "").toLowerCase() : "";

            // 4. ALT - image alt text
            const mainImg = icon.querySelector('img:not([class*="icon-badge-pos"])');
            const alt = mainImg ? (mainImg.getAttribute('alt') || "").toLowerCase() : "";

            // 5. TAB - extracted from parent section ID
            const tab = sec.id.toLowerCase();

            // 6. INFO - badge filenames (search badge names)
            const badges = Array.from(icon.querySelectorAll('[class*="icon-badge-pos"]'));
            const info = badges.map(b => {
                const src = b.getAttribute('src') || "";
                // Extract filename without path (e.g., "icon/new.png" â†’ "new.png")
                return src.split('/').pop().replace('.png', '').toLowerCase();
            }).join(' ');

            // ========================================
            // MATCH LOGIC
            // ========================================
            if (
                txt.includes(q) ||
                tooltip.includes(q) ||
                href.includes(q) ||
                alt.includes(q) ||
                tab.includes(q) ||
                info.includes(q)
            ) {
                // Check if already added (by href)
                const alreadyAdded = foundItems.some(item => item.href === href);

                if (!alreadyAdded) {
                    foundItems.push({
                        text: txt,      // For sorting alphabetically
                        href: href,     // For duplicate checking
                        element: icon.closest("li").cloneNode(true)
                    });
                }
            }
        });
    });

    // ========================================
    // SORT ALPHABETICALLY & DISPLAY
    // ========================================
    if (foundItems.length > 0) {
        // Sort by text field
        foundItems.sort((a, b) => a.text.localeCompare(b.text));
        
        // Append sorted elements
        foundItems.forEach(item => {
            grid.appendChild(item.element);
        });

        resultSec.appendChild(grid);
        resultSec.classList.add("active");
    } else {
        resultSec.classList.remove("active");
    }
    requestAnimationFrame(() => { if (typeof fixScaleSpacing === 'function') fixScaleSpacing(); });
});
</script>


<!-- ============================================================
     JS SECTION 7 â€” COPY BUTTON SOUND
============================================================ -->

<script>
document.addEventListener("click", (e) => {
    if (e.target.id === "copy-tip-btn") {
        document.getElementById("copy-sfx").play();
    }
});
</script>


<script>
/* ============================================================
   MOBILE / DESKTOP MODE TOGGLE
   ============================================================
   REPLACE the entire JS SECTION 8 (around line 625-760)
   with this simplified version:
============================================================ */

// DOM references
const mobileToggle = document.getElementById("mobile-toggle");
const wrapper = document.getElementById("page-wrapper");

// State capture/restore for preserving active tabs
function captureUIState() {
    return {
        activeTabBtn: document.querySelector(".tab-btn.active"),
        activeHeaderLink: document.querySelector(".header-text-link.active"),
        activeSection: document.querySelector(".tab-content.active")
    };
}

function restoreUIState(state) {
    const hasSomething = state.activeTabBtn || state.activeHeaderLink || state.activeSection;
    
    if (hasSomething) {
        document.querySelectorAll(".tab-btn, .header-text-link")
            .forEach(el => el.classList.remove("active"));
        document.querySelectorAll(".tab-content")
            .forEach(sec => sec.classList.remove("active"));
        
        if (state.activeTabBtn) state.activeTabBtn.classList.add("active");
        if (state.activeHeaderLink) state.activeHeaderLink.classList.add("active");
        if (state.activeSection) state.activeSection.classList.add("active");
    }
}

function enableMobileMode(state) {
  document.body.classList.add("mobile-mode");
  localStorage.setItem("ui-mode", "mobile");
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      restoreUIState(state);
      if (typeof positionContent === "function") positionContent();
    });
  });
}

function disableMobileMode(state) {
  document.body.classList.remove("mobile-mode");
  localStorage.setItem("ui-mode", "desktop");
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      restoreUIState(state);
      if (typeof positionContent === "function") positionContent();
    });
  });
}

// Fade transition
function swapModeWithFade(enableMobile) {
    wrapper.classList.add("fading");
    setTimeout(() => {
        const state = captureUIState();
        if (enableMobile) enableMobileMode(state);
        else disableMobileMode(state);
        wrapper.style.visibility = "visible";
    }, 50);
    setTimeout(() => {
        wrapper.classList.remove("fading");
    }, 200);
}

// Toggle button handler
if (mobileToggle) {
    mobileToggle.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (typeof clearDoubleTapSelection === "function") clearDoubleTapSelection();
        mobileToggle.classList.add("blink");
        setTimeout(() => mobileToggle.classList.remove("blink"), 150);
        mobileToggle.classList.remove("active");
        const enableMobile = !document.body.classList.contains("mobile-mode");
        swapModeWithFade(enableMobile);
    });
}

// Restore mode on page load
window.addEventListener("load", () => {
    // Transfer mobile-mode from html to body if it was set early
    if (document.documentElement.classList.contains('mobile-mode-loading')) {
        document.documentElement.classList.remove('mobile-mode-loading');
        const state = captureUIState();
        enableMobileMode(state);
        return;
    }
    
    // Auto-detect mobile devices and apply mobile-mode by default
    const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                          || (window.innerWidth <= 768);
    
    const savedMode = localStorage.getItem("ui-mode");
    
    // If no saved preference, use auto-detection
    if (!savedMode) {
        if (isMobileDevice) {
            const state = captureUIState();
            enableMobileMode(state);
        }
    }
    // If user has saved preference, respect it
    else if (savedMode === "mobile") {
        const state = captureUIState();
        enableMobileMode(state);
    }
});

// Font readiness check
window.addEventListener("load", () => {
    if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => {
            if (typeof positionContent === "function") positionContent();
        });
    }
});

// BFCache restore
window.addEventListener("pageshow", () => {
    if (typeof positionContent === "function") positionContent();
});

// Auto-enable mobile mode on smartphones
(function() {
    const isMobileDevice = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (isMobileDevice && localStorage.getItem("ui-mode") !== "mobile") {
        const state = captureUIState?.() || {};
        enableMobileMode(state);
    }
})();

</script>


<!-- ============================================================
     JS SECTION 9 â€” DEFERRED FIREFLY BACKGROUND LOADER
     ------------------------------------------------------------
     - Runs AFTER page is fully loaded
     - Uses idle time when possible
     - Zero impact on interactivity
============================================================ -->
<script>
(function () {
    const PARTICLE_COUNT = 33;

    function createFireflies() {
        const fireflyLayer = document.getElementById("firefly-layer");
        if (!fireflyLayer) return;

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const f = document.createElement("div");
            f.className = "firefly";

            f.style.setProperty("--x", Math.random() * 100);
            f.style.setProperty("--duration", 8 + Math.random() * 10 + "s");
            f.style.setProperty("--fade-duration", 2 + Math.random() * 3 + "s");
            f.style.setProperty("--delay", Math.random() * 10 + "s");
            f.style.setProperty("--firefly-size", 3 + Math.random() * 4 + "px");

            fireflyLayer.appendChild(f);
        }
    }

    function deferFireflies() {
        if ("requestIdleCallback" in window) {
            requestIdleCallback(createFireflies, { timeout: 1500 });
        } else {
            setTimeout(createFireflies, 800);
        }
    }

    // window.addEventListener("load", deferFireflies);  â† Just add // to disable
})();
</script>
    
<!-- DIAGNOSTIC: Scroll height debugging -->
<script>
setTimeout(() => {
    const area = document.getElementById('content-area');
    const scale = document.getElementById('content-scale');
    console.log('=== SCROLL DIAGNOSTIC ===');
    console.log('content-area scrollHeight:', area.scrollHeight);
    console.log('content-area clientHeight:', area.clientHeight);
    console.log('content-scale offsetHeight:', scale.offsetHeight);
    console.log('Difference (extra scroll):', area.scrollHeight - area.clientHeight);
    console.log('Mobile mode active:', document.body.classList.contains('mobile-mode'));
    console.log('Scale factor:', getComputedStyle(document.documentElement).getPropertyValue('--mobile-scale'));
}, 2000);
</script>

</div>
</body>
</html>
